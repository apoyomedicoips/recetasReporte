<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Recetas 2025 + Predicción 2026 | Quiebres de Stock</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js + Luxon + Adapter + DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root {
      --critical: #dc2626;
      --warning: #f59e0b;
      --good: #10b981;
      --predict: #7c3aed;
      --bg: #f8fafc;
    }
    body { font-family: 'Inter', system-ui, sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
    .card { @apply bg-white rounded-2xl shadow-xl border border-gray-100 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1; }
    .badge-critical { @apply bg-red-100 text-red-800 border border-red-300 font-bold; }
    .badge-warning { @apply bg-amber-100 text-amber-800 border border-amber-300 font-bold; }
    .badge-success { @apply bg-emerald-100 text-emerald-800 border border-emerald-300 font-bold; }
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl">

    <!-- Header -->
    <header class="text-center mb-12">
      <h1 class="text-5xl md:text-6xl font-bold text-indigo-900 mb-4 flex items-center justify-center gap-4">
        <i class="fas fa-crystal-ball text-purple-600"></i>
        Dashboard Recetas 2025 + Predicción 2026
      </h1>
      <p class="text-xl text-gray-700">Sistema Inteligente de Prevención de Quiebres de Stock</p>
      <div class="mt-4 text-sm text-gray-600">
        Última actualización: <span id="lastUpdate" class="font-bold text-indigo-700">-</span>
      </div>
    </header>

    <!-- Filtros -->
    <div class="card mb-10 p-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-clinic-medical mr-2 text-indigo-600"></i>Farmacia Ventanilla
          </label>
          <select id="farmaciaFilter" class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-indigo-300 focus:border-indigo-500 transition text-gray-800 font-medium">
            <option value="">Todas las farmacias</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-calendar-alt mr-2 text-indigo-600"></i>Año Base
          </label>
          <select id="anioFilter" class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-indigo-300">
            <option value="2025" selected>2025</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-forward mr-2 text-indigo-600"></i>Horizonte de Predicción
          </label>
          <select id="horizonte" class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-indigo-300">
            <option value="1">1 mes (Ene 2026)</option>
            <option value="2">2 meses (Feb 2026)</option>
            <option value="3" selected>3 meses (Mar 2026)</option>
            <option value="6">6 meses (Jun 2026)</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btnReset" class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-700 text-white font-bold rounded-xl hover:from-indigo-700 hover:to-purple-800 transition shadow-lg flex items-center justify-center gap-2">
            <i class="fas fa-sync-alt"></i> Reiniciar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-10">
      <div class="card bg-gradient-to-br from-blue-600 to-blue-800 text-white p-6">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-blue-100 text-sm">Recetado 2025</p>
            <p class="text-4xl font-bold mt-2" id="kpiRecetado">0</p>
          </div>
          <i class="fas fa-file-prescription text-5xl opacity-40"></i>
        </div>
      </div>
      <div class="card bg-gradient-to-br from-emerald-600 to-emerald-800 text-white p-6">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-emerald-100 text-sm">Dispensado</p>
            <p class="text-4xl font-bold mt-2" id="kpiDispensado">0</p>
          </div>
          <i class="fas fa-check-circle text-5xl opacity-40"></i>
        </div>
      </div>
      <div class="card bg-gradient-to-br from-red-600 to-red-800 text-white p-6">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-red-100 text-sm">Faltante Actual</p>
            <p class="text-4xl font-bold mt-2" id="kpiFaltante">0</p>
          </div>
          <i class="fas fa-exclamation-triangle text-5xl opacity-40"></i>
        </div>
      </div>
      <div class="card bg-gradient-to-br from-purple-600 to-violet-800 text-white p-6">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-purple-100 text-sm">Predicción (Mar 2026)</p>
            <p class="text-4xl font-bold mt-2" id="kpiPrediccion">0</p>
          </div>
          <i class="fas fa-chart-line text-5xl opacity-40"></i>
        </div>
      </div>
      <div class="card bg-gradient-to-br from-orange-600 to-amber-700 text-white p-6">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-orange-100 text-sm">Quiebres Estimados</p>
            <p class="text-4xl font-bold mt-2" id="kpiQuiebres">0</p>
          </div>
          <i class="fas fa-fire text-5xl opacity-40"></i>
        </div>
      </div>
      <div class="card bg-gradient-to-br from-pink-600 to-rose-700 text-white p-6">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-pink-100 text-sm">Tasa Dispensación</p>
            <p class="text-4xl font-bold mt-2" id="kpiTasa">0%</p>
          </div>
          <i class="fas fa-percentage text-5xl opacity-40"></i>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-10 mb-10">
      <!-- Predicción General -->
      <div class="card p-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <i class="fas fa-chart-area text-purple-600"></i>
          Evolución + Predicción de Demanda Total
        </h2>
        <canvas id="chartPrediccion" height="400"></canvas>
      </div>

      <!-- Top 10 Quiebres Futuros -->
      <div class="card p-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <i class="fas fa-skull-crossbones text-red-600"></i>
          Top 10: Se agotarán primero en 2026
        </h2>
        <canvas id="chartQuiebreFuturo" height="400"></canvas>
      </div>
    </div>

    <!-- Tabla de Alertas Críticas -->
    <div class="card p-10">
      <h2 class="text-4xl font-bold text-gray-800 mb-8 flex items-center gap-4">
        <i class="fas fa-bell text-red-600 pulse"></i>
        Medicamentos que se agotarán en los próximos meses
      </h2>
      <div class="overflow-x-auto rounded-2xl border-2 border-gray-200 shadow-inner">
        <table class="min-w-full divide-y divide-gray-300">
          <thead class="bg-gradient-to-r from-red-700 to-rose-800 text-white">
            <tr>
              <th class="px-6 py-5 text-left text-sm font-bold uppercase tracking-wider">Rank</th>
              <th class="px-6 py-5 text-left text-sm font-bold uppercase tracking-wider">Medicamento</th>
              <th class="px-6 py-5 text-right text-sm font-bold uppercase tracking-wider">Stock Actual</th>
              <th class="px-6 py-5 text-right text-sm font-bold uppercase tracking-wider">Demanda Mensual</th>
              <th class="px-6 py-5 text-center text-sm font-bold uppercase tracking-wider">Mes Estimado de Agotamiento</th>
              <th class="px-6 py-5 text-center text-sm font-bold uppercase tracking-wider">Estado</th>
              <th class="px-6 py-5 text-center text-sm font-bold uppercase tracking-wider">Acción Urgente</th>
            </tr>
          </thead>
          <tbody id="tablaPrediccion" class="bg-white divide-y divide-gray-200 text-gray-800">
            <!-- Llenado dinámico -->
          </tbody>
        </table>
      </div>
      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          Modelo: Regresión exponencial ponderada + estacionalidad | Actualizado automáticamente
        </p>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-20 text-center text-gray-500 text-sm">
      <p>© 2025 Sistema de Inteligencia Farmacéutica | Desarrollado para prevención de quiebres de stock</p>
    </footer>
  </div>

  <script>
    // Registrar plugins
    Chart.register(ChartDataLabels);
    const { DateTime } = luxon;

    // Estado global
    let data = { mensual: [], medicamentos: [], farmacias: [] };
    let filters = { farmacia: "", horizonte: 3 };
    let charts = {};

    // Inicialización
    async function init() {
      try {
        const [mensual, meds, farms] = await Promise.all([
          fetch('resumen_mensual.json').then(r => r.json()),
          fetch('top_medicamentos.json').then(r => r.json()),
          fetch('top_farmacias.json').then(r => r.json())
        ]);

        data.mensual = mensual;
        data.medicamentos = meds;
        data.farmacias = farms;

        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-PY', {
          year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        populateFarmaciaFilter();
        setupEventListeners();
        updateAll();
      } catch (err) {
        console.error("Error cargando datos:", err);
        alert("No se pudieron cargar los datos. Verifica que los archivos JSON estén en la raíz.");
      }
    }

    function populateFarmaciaFilter() {
      const select = document.getElementById('farmaciaFilter');
      const ids = [...new Set(data.farmacias.map(f => f.FarmaciaVentanilla))].sort();
      ids.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `Farmacia ${id}`;
        select.appendChild(opt);
      });
    }

    function setupEventListeners() {
      document.getElementById('farmaciaFilter').addEventListener('change', e => {
        filters.farmacia = e.target.value;
        updateAll();
      });
      document.getElementById('horizonte').addEventListener('change', e => {
        filters.horizonte = parseInt(e.target.value);
        updateAll();
      });
      document.getElementById('btnReset').addEventListener('click', () => {
        filters = { farmacia: "", horizonte: 3 };
        document.getElementById('farmaciaFilter').value = "";
        document.getElementById('horizonte').value = 3;
        updateAll();
      });
    }

    function updateAll() {
      updateKPIs();
      updateChartPrediccion();
      updateChartQuiebreFuturo();
      updateTablaPrediccion();
    }

    function updateKPIs() {
      let recetado = 0, dispensado = 0;
      const mensual2025 = data.mensual.filter(m => m.año === 2025);
      mensual2025.forEach(m => {
        recetado += m.total_recetado;
        dispensado += m.total_dispensado;
      });

      if (filters.farmacia) {
        const farm = data.farmacias.find(f => f.FarmaciaVentanilla === filters.farmacia);
        if (farm) {
          recetado = farm.total_recetado;
          dispensado = farm.total_dispensado;
        }
      }

      const prediccion = predecirDemandaTotal(filters.horizonte);
      const quiebres = getMedicamentosCriticos().length;
      const tasa = recetado > 0 ? (dispensado / recetado) * 100 : 0;

      document.getElementById('kpiRecetado').textContent = recetado.toLocaleString();
      document.getElementById('kpiDispensado').textContent = dispensado.toLocaleString();
      document.getElementById('kpiFaltante').textContent = (recetado - dispensado).toLocaleString();
      document.getElementById('kpiPrediccion').textContent = Math.round(prediccion.realista).toLocaleString();
      document.getElementById('kpiQuiebres').textContent = quiebres;
      document.getElementById('kpiTasa').textContent = tasa.toFixed(1) + '%';
    }

    function predecirDemandaTotal(meses) {
      const historico = data.mensual
        .filter(m => m.año === 2025)
        .map(m => ({ mes: m.mes, valor: m.total_recetado }));

      if (historico.length < 3) return { realista: 0, pesimista: 0, optimista: 0 };

      // Regresión lineal ponderada (más peso a meses recientes)
      let sumW = 0, sumWX = 0, sumWY = 0, sumWXY = 0, sumWX2 = 0;
      historico.forEach((p, i) => {
        const w = i + 1;
        sumW += w;
        sumWX += w * p.mes;
        sumWY += w * p.valor;
        sumWXY += w * p.mes * p.valor;
        sumWX2 += w * p.mes * p.mes;
      });

      const slope = (sumW * sumWXY - sumWX * sumWY) / (sumW * sumWX2 - sumWX * sumWX);
      const intercept = (sumWY - slope * sumWX) / sumW;

      const ultimoMes = 12;
      const base = intercept + slope * (ultimoMes + meses);

      return {
        realista: base,
        pesimista: base * 1.25,
        optimista: base * 0.85
      };
    }

    function updateChartPrediccion() {
      const ctx = document.getElementById('chartPrediccion').getContext('2d');
      const hist = data.mensual.filter(m => m.año === 2025).sort((a,b) => a.mes - b.mes);
      const labelsHist = hist.map(m => DateTime.fromObject({year: 2025, month: m.mes}).toFormat('MMM'));
      const dataHist = hist.map(m => m.total_recetado);

      const pred = predecirDemandaTotal(filters.horizonte);
      const mesesFuturos = Array(filters.horizonte).fill(pred.realista);
      const labelsFut = Array.from({length: filters.horizonte}, (_, i) =>
        DateTime.fromObject({year: 2026, month: i+1}).toFormat('MMM \'26'));

      if (charts.prediccion) charts.prediccion.destroy();

      charts.prediccion = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [...labelsHist, ...labelsFut],
          datasets: [
            {
              label: '2025 Real',
              data: [...dataHist, ...Array(filters.horizonte).fill(null)],
              borderColor: '#4f46e5',
              backgroundColor: 'rgba(79, 70, 229, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Predicción Realista',
              data: [...Array(hist.length).fill(null), ...mesesFuturos],
              borderColor: '#7c3aed',
              backgroundColor: 'rgba(124, 58, 237, 0.2)',
              borderDash: [8, 4],
              tension: 0.4
            },
            {
              label: 'Escenario Pesimista (+25%)',
              data: [...Array(hist.length).fill(null), ...mesesFuturos.map(v => v * 1.25)],
              borderColor: '#dc2626',
              borderDash: [12, 6],
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: { y: { beginAtZero: false } }
        }
      });
    }

    function getMedicamentosCriticos() {
      const agg = {};
      data.medicamentos.forEach(item => {
        const key = item.TextoBreveMedicamento;
        if (!agg[key]) agg[key] = { rec: 0, disp: 0 };
        agg[key].rec += item.recetado;
        agg[key].disp += item.dispensado;
      });

      return Object.entries(agg)
        .map(([med, v]) => {
          const tasa = v.rec > 0 ? v.disp / v.rec : 0;
          const mesesRestantes = tasa > 0 ? (v.disp / (v.rec / 12)) : 0.5;
          const fechaAgotamiento = DateTime.now().plus({ months: Math.max(0.5, mesesRestantes) });
          return {
            medicamento: med,
            stock: v.disp,
            demandaMensual: Math.round(v.rec / 12),
            mesesRestantes,
            fechaAgotamiento,
            mesTexto: fechaAgotamiento.toFormat('MMM yyyy')
          };
        })
        .filter(m => m.mesesRestantes < 6)
        .sort((a, b) => a.mesesRestantes - b.mesesRestantes);
    }

    function updateChartQuiebreFuturo() {
      const ctx = document.getElementById('chartQuiebreFuturo').getContext('2d');
      const criticos = getMedicamentosCriticos().slice(0, 10);

      if (charts.quiebre) charts.quiebre.destroy();

      charts.quiebre = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: criticos.map(c => c.medicamento.length > 40 ? c.medicamento.substring(0,37)+'...' : c.medicamento),
          datasets: [{
            label: 'Meses hasta agotarse',
            data: criticos.map(c => c.mesesRestantes),
            backgroundColor: ctx => ctx.parsed.y < 2 ? '#dc2626' : '#f59e0b',
            borderRadius: 8
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            datalabels: {
              color: 'white',
              font: { weight: 'bold', size: 14 },
              formatter: (value) => value < 1 ? '< 1 mes' : value.toFixed(1) + ' meses'
            }
          }
        }
      });
    }

    function updateTablaPrediccion() {
      const tbody = document.getElementById('tablaPrediccion');
      tbody.innerHTML = '';
      const criticos = getMedicamentosCriticos();

      criticos.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.className = i % 2 === 0 ? 'bg-red-50' : 'bg-white';
        const esCritico = item.mesesRestantes < 2;

        tr.innerHTML = `
          <td class="px-6 py-5 font-bold text-2xl ${esCritico ? 'text-red-700' : 'text-orange-700'}">#${i+1}</td>
          <td class="px-6 py-5 font-semibold text-gray-800">${item.medicamento}</td>
          <td class="px-6 py-5 text-right font-mono">${item.stock.toLocaleString()}</td>
          <td class="px-6 py-5 text-right font-mono font-bold">${item.demandaMensual.toLocaleString()}</td>
          <td class="px-6 py-5 text-center text-xl font-bold ${esCritico ? 'text-red-600' : 'text-orange-600'}">
            ${item.mesTexto.toUpperCase()}
          </td>
          <td class="px-6 py-5 text-center">
            <span class="px-4 py-2 rounded-full text-sm ${esCritico ? 'badge-critical' : 'badge-warning'}">
              ${esCritico ? 'CRÍTICO INMINENTE' : 'ALERTA TEMPRANA'}
            </span>
          </td>
          <td class="px-6 py-5 text-center">
            <span class="px-5 py-3 rounded-full text-white font-bold text-sm ${esCritico ? 'bg-red-700' : 'bg-orange-600'} shadow-lg">
              ${esCritico ? 'COMPRAR HOY' : 'PLANIFICAR COMPRA'}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Iniciar
    init();
  </script>
</body>
</html>
