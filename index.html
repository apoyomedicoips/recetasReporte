<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Recetas 2025 | Reporte Farmacias</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .card { @apply bg-white rounded-xl shadow-lg p-6 border border-gray-100; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl">

    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-4xl font-bold text-indigo-800 mb-2">Dashboard Recetas 2025</h1>
      <p class="text-gray-600">Análisis de dispensación y detección de quiebres de stock</p>
    </header>

    <!-- Filtros -->
    <div class="card mb-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Farmacia Ventanilla</label>
          <select id="farmaciaFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">Todas las farmacias</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Año</label>
          <select id="anioFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">Todos los años</option>
            <option value="2025" selected>2025</option>
          </select>
        </div>
        <div class="flex items-end">
          <div class="text-sm text-gray-500">
            Última actualización: <span id="lastUpdate">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white">
        <h3 class="text-lg font-semibold">Total Recetado</h3>
        <p class="text-3xl font-bold mt-2" id="kpiRecetado">0</p>
      </div>
      <div class="card bg-gradient-to-br from-green-500 to-emerald-600 text-white">
        <h3 class="text-lg font-semibold">Total Dispensado</h3>
        <p class="text-3xl font-bold mt-2" id="kpiDispensado">0</p>
      </div>
      <div class="card bg-gradient-to-br from-yellow-500 to-amber-600 text-white">
        <h3 class="text-lg font-semibold">Faltante Crítico</h3>
        <p class="text-3xl font-bold mt-2" id="kpiFaltante">0</p>
      </div>
      <div class="card bg-gradient-to-br from-purple-500 to-indigo-600 text-white">
        <h3 class="text-lg font-semibold">Tasa de Dispensación</h3>
        <p class="text-3xl font-bold mt-2" id="kpiTasa">0%</p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Gráfico Evolución Mensual -->
      <div class="card">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Evolución Mensual: Recetado vs Dispensado</h2>
        <canvas id="chartEvolucion"></canvas>
      </div>

      <!-- Gráfico Quiebre de Stock (Top 10 medicamentos con mayor faltante) -->
      <div class="card">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Top 10 Medicamentos con Mayor Faltante (Quiebre de Stock)</h2>
        <canvas id="chartQuiebre"></canvas>
      </div>
    </div>

    <!-- Tabla Top Faltantes -->
    <div class="card">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Top Faltantes por Medicamento (Filtrado)</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="tablaFaltantes">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medicamento</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Recetado</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Dispensado</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Faltante</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Tasa</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="tablaBody">
            <!-- Rellenado dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Estado global
    let resumenMensual = [];
    let topMedicamentos = [];
    let topFarmacias = [];
    let selectedFarmacia = "";
    let selectedAnio = "2025";

    // Cargar datos
    async function loadData() {
      try {
        const [res1, res2, res3] = await Promise.all([
          fetch('resumen_mensual.json').then(r => r.json()),
          fetch('top_medicamentos.json').then(r => r.json()),
          fetch('top_farmacias.json').then(r => r.json())
        ]);
        resumenMensual = res1;
        topMedicamentos = res2;
        topFarmacias = res3;

        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-PY');

        populateFarmaciaFilter();
        updateDashboard();
      } catch (err) {
        console.error("Error cargando datos:", err);
      }
    }

    function populateFarmaciaFilter() {
      const select = document.getElementById('farmaciaFilter');
      const farmacias = [...new Set(topFarmacias.map(f => f.FarmaciaVentanilla))].sort();
      farmacias.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `Farmacia ${id}`;
        select.appendChild(opt);
      });
    }

    // Filtros reactivos
    document.getElementById('farmaciaFilter').addEventListener('change', (e) => {
      selectedFarmacia = e.target.value;
      updateDashboard();
    });

    document.getElementById('anioFilter').addEventListener('change', (e) => {
      selectedAnio = e.target.value || "2025";
      updateDashboard();
    });

    // Actualizar todo el dashboard
    function updateDashboard() {
      updateKPIs();
      updateChartEvolucion();
      updateChartQuiebreStock();
      updateTablaFaltantes();
    }

    function updateKPIs() {
      let totalRecetado = 0;
      let totalDispensado = 0;

      const filteredMensual = resumenMensual.filter(m => {
        const matchAnio = !selectedAnio || m.año === parseInt(selectedAnio);
        return matchAnio;
      });

      filteredMensual.forEach(m => {
        totalRecetado += m.total_recetado;
        totalDispensado += m.total_dispensado;
      });

      // Si hay filtro de farmacia, usar top_farmacias
      if (selectedFarmacia) {
        const farmacia = topFarmacias.find(f => f.FarmaciaVentanilla === selectedFarmacia);
        if (farmacia) {
          totalRecetado = farmacia.total_recetado;
          totalDispensado = farmacia.total_dispensado;
        }
      }

      const faltante = totalRecetado - totalDispensado;
      const tasa = totalRecetado > 0 ? (totalDispensado / totalRecetado) * 100 : 0;

      document.getElementById('kpiRecetado').textContent = totalRecetado.toLocaleString();
      document.getElementById('kpiDispensado').textContent = totalDispensado.toLocaleString();
      document.getElementById('kpiFaltante').textContent = faltante.toLocaleString();
      document.getElementById('kpiTasa').textContent = tasa.toFixed(2) + '%';
    }

    let chartEvolucion, chartQuiebre;

    function updateChartEvolucion() {
      const ctx = document.getElementById('chartEvolucion').getContext('2d');
      const labels = [];
      const recetado = [];
      const dispensado = [];

      const filtered = resumenMensual
        .filter(m => !selectedAnio || m.año === parseInt(selectedAnio))
        .sort((a, b) => a.mes - b.mes);

      filtered.forEach(m => {
        labels.push(luxon.DateTime.fromObject({ year: m.año, month: m.mes }).toFormat('MMM yyyy'));
        recetado.push(m.total_recetado);
        dispensado.push(m.total_dispensado);
      });

      if (chartEvolucion) chartEvolucion.destroy();

      chartEvolucion = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Recetado',
              data: recetado,
              borderColor: '#6366f1',
              backgroundColor: 'rgba(99, 102, 241, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Dispensado',
              data: dispensado,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: false } }
        }
      });
    }

    function updateChartQuiebreStock() {
      const ctx = document.getElementById('chartQuiebre').getContext('2d');

      const agg = {};
      topMedicamentos.forEach(item => {
        if (selectedAnio && item.año !== parseInt(selectedAnio)) return;
        const key = item.TextoBreveMedicamento;
        if (!agg[key]) {
          agg[key] = { recetado: 0, dispensado: 0 };
        }
        agg[key].recetado += item.recetado;
        agg[key].dispensado += item.dispensado;
      });

      const data = Object.entries(agg)
        .map(([med, vals]) => ({
          medicamento: med.length > 50 ? med.substring(0,47)+'...' : med,
          faltante: vals.recetado - vals.dispensado
        }))
        .filter(d => d.faltante > 0)
        .sort((a, b) => b.faltante - a.faltante)
        .slice(0, 10);

      if (chartQuiebre) chartQuiebre.destroy();

      chartQuiebre = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.medicamento),
          datasets: [{
            label: 'Faltante (Unidades)',
            data: data.map(d => d.faltante),
            backgroundColor: '#ef4444',
            borderColor: '#dc2626',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `${ctx.raw.toLocaleString()} unidades faltantes` }}
          },
          scales: { x: { beginAtZero: true } }
        }
      });
    }

    function updateTablaFaltantes() {
      const tbody = document.getElementById('tablaBody');
      tbody.innerHTML = '';

      const agg = {};
      topMedicamentos.forEach(item => {
        if (selectedAnio && item.año !== parseInt(selectedAnio)) return;
        const key = item.TextoBreveMedicamento;
        if (!agg[key]) agg[key] = { recetado: 0, dispensado: 0 };
        agg[key].recetado += item.recetado;
        agg[key].dispensado += item.dispensado;
      });

      const rows = Object.entries(agg)
        .map(([med, vals]) => ({
          medicamento: med,
          recetado: vals.recetado,
          dispensado: vals.dispensado,
          faltante: vals.recetado - vals.dispensado,
          tasa: vals.recetado > 0 ? (vals.dispensado / vals.recetado) : 0
        }))
        .filter(r => r.faltante > 0)
        .sort((a, b) => b.faltante - a.faltante);

      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-6 py-4 text-sm text-gray-900 whitespace-nowrap">${r.medicamento}</td>
          <td class="px-6 py-4 text-sm text-right text-gray-700">${r.recetado.toLocaleString()}</td>
          <td class="px-6 py-4 text-sm text-right text-gray-700">${r.dispensado.toLocaleString()}</td>
          <td class="px-6 py-4 text-sm text-right font-semibold text-red-600">${r.faltante.toLocaleString()}</td>
          <td class="px-6 py-4 text-sm text-right ${r.tasa < 0.8 ? 'text-red-600' : 'text-green-600'}">
            ${(r.tasa * 100).toFixed(1)}%
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Inicializar
    loadData();
  </script>
</body>
</html>
