<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard IPS Inteligente | Predicción Stock 2026</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js + Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root {
      --critical: #dc2626;
      --warning: #f59e0b;
      --good: #10b981;
      --predict: #7c3aed;
      --bg: #f8fafc;
    }
    
    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
    }
    
    .card { 
      @apply bg-white rounded-2xl shadow-xl border border-gray-100 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 overflow-hidden;
    }
    
    /* CONTENEDORES ESPECÍFICOS PARA GRÁFICOS - FIJOS */
    .chart-container {
      position: relative;
      height: 350px; /* ALTURA FIJA */
      width: 100%;
      overflow: hidden;
    }
    
    .chart-container-sm {
      position: relative;
      height: 250px; /* ALTURA MÁS PEQUEÑA */
      width: 100%;
      overflow: hidden;
    }
    
    .kpi-container {
      position: relative;
      height: 180px;
      overflow: hidden;
    }
    
    /* Asegurar que los canvas no se salgan */
    canvas {
      max-height: 100% !important;
      max-width: 100% !important;
    }
    
    /* Scroll personalizado */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }
    
    /* Animaciones */
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
    
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Dark mode */
    .dark body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    .dark .card { @apply bg-gray-800 border-gray-700; }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Botón modo oscuro -->
  <div class="fixed top-4 right-4 z-50">
    <button id="darkModeToggle" class="p-3 bg-white dark:bg-gray-800 rounded-full shadow-lg hover:shadow-xl transition">
      <i class="fas fa-moon text-gray-600 dark:text-yellow-300"></i>
    </button>
  </div>
  
  <div class="container mx-auto px-4 py-8 max-w-7xl">

    <!-- Header -->
    <header class="text-center mb-10 fade-in">
      <h1 class="text-4xl md:text-5xl font-bold text-indigo-900 dark:text-white mb-4 flex items-center justify-center gap-4">
        <i class="fas fa-brain text-purple-600 dark:text-purple-400"></i>
        Dashboard Predictivo IPS 2025-2026
      </h1>
      <p class="text-lg text-gray-700 dark:text-gray-300">Sistema de Inteligencia para Prevención de Quiebres de Stock</p>
      <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
        <i class="fas fa-clock mr-2"></i>Última actualización: 
        <span id="lastUpdate" class="font-bold text-indigo-700 dark:text-indigo-300">Cargando...</span>
      </div>
    </header>

    <!-- Filtros Responsivos -->
    <div class="card mb-8 p-6 fade-in">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-clinic-medical mr-2 text-indigo-600"></i>Farmacia
          </label>
          <select id="farmaciaFilter" class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition">
            <option value="">Todas las farmacias</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-calendar-alt mr-2 text-indigo-600"></i>Horizonte
          </label>
          <select id="horizonte" class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-300">
            <option value="1">1 mes</option>
            <option value="2">2 meses</option>
            <option value="3" selected>3 meses</option>
            <option value="6">6 meses</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
            <i class="fas fa-filter mr-2 text-indigo-600"></i>Nivel Riesgo
          </label>
          <select id="nivelRiesgo" class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-300">
            <option value="">Todos</option>
            <option value="critico">Crítico</option>
            <option value="alto">Alto</option>
            <option value="medio">Medio</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btnReset" class="w-full px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition shadow flex items-center justify-center gap-2">
            <i class="fas fa-redo"></i> Reiniciar
          </button>
        </div>
      </div>
    </div>

    <!-- KPIs Compactos -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8 fade-in">
      <div class="card bg-gradient-to-br from-blue-600 to-blue-800 text-white p-4 kpi-container">
        <div class="flex justify-between items-start h-full">
          <div>
            <p class="text-blue-100 text-xs opacity-90">Recetado 2025</p>
            <p class="text-2xl font-bold mt-1" id="kpiRecetado">0</p>
          </div>
          <i class="fas fa-file-prescription text-3xl opacity-40"></i>
        </div>
      </div>
      
      <div class="card bg-gradient-to-br from-emerald-600 to-emerald-800 text-white p-4 kpi-container">
        <div class="flex justify-between items-start h-full">
          <div>
            <p class="text-emerald-100 text-xs opacity-90">Dispensado</p>
            <p class="text-2xl font-bold mt-1" id="kpiDispensado">0</p>
          </div>
          <i class="fas fa-check-circle text-3xl opacity-40"></i>
        </div>
      </div>
      
      <div class="card bg-gradient-to-br from-red-600 to-red-800 text-white p-4 kpi-container">
        <div class="flex justify-between items-start h-full">
          <div>
            <p class="text-red-100 text-xs opacity-90">Faltante</p>
            <p class="text-2xl font-bold mt-1" id="kpiFaltante">0</p>
          </div>
          <i class="fas fa-exclamation-triangle text-3xl opacity-40"></i>
        </div>
      </div>
      
      <div class="card bg-gradient-to-br from-purple-600 to-violet-800 text-white p-4 kpi-container">
        <div class="flex justify-between items-start h-full">
          <div>
            <p class="text-purple-100 text-xs opacity-90">Predicción 2026</p>
            <p class="text-2xl font-bold mt-1" id="kpiPrediccion">0</p>
          </div>
          <i class="fas fa-chart-line text-3xl opacity-40"></i>
        </div>
      </div>
      
      <div class="card bg-gradient-to-br from-orange-600 to-amber-700 text-white p-4 kpi-container">
        <div class="flex justify-between items-start h-full">
          <div>
            <p class="text-orange-100 text-xs opacity-90">Quiebres</p>
            <p class="text-2xl font-bold mt-1" id="kpiQuiebres">0</p>
          </div>
          <i class="fas fa-fire text-3xl opacity-40"></i>
        </div>
      </div>
      
      <div class="card bg-gradient-to-br from-pink-600 to-rose-700 text-white p-4 kpi-container">
        <div class="flex justify-between items-start h-full">
          <div>
            <p class="text-pink-100 text-xs opacity-90">Tasa Disp.</p>
            <p class="text-2xl font-bold mt-1" id="kpiTasa">0%</p>
          </div>
          <i class="fas fa-percentage text-3xl opacity-40"></i>
        </div>
      </div>
    </div>

    <!-- Gráficos Principales con Contenedores Fijos -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8 fade-in">
      <!-- Gráfico 1: Predicción -->
      <div class="card p-6">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-3">
          <i class="fas fa-chart-line text-purple-600"></i>
          Evolución + Predicción de Demanda
        </h2>
        <!-- CONTENEDOR FIJO para el gráfico -->
        <div class="chart-container">
          <canvas id="chartPrediccion"></canvas>
        </div>
        <div class="mt-3 text-xs text-gray-600 dark:text-gray-400">
          <i class="fas fa-info-circle mr-1"></i>Modelo: Regresión lineal + estacionalidad ajustada
        </div>
      </div>

      <!-- Gráfico 2: Quiebres Futuros -->
      <div class="card p-6">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-3">
          <i class="fas fa-skull-crossbones text-red-600"></i>
          Top 10 Medicamentos en Riesgo
        </h2>
        <!-- CONTENEDOR FIJO para el gráfico -->
        <div class="chart-container">
          <canvas id="chartQuiebreFuturo"></canvas>
        </div>
        <div class="mt-3 text-xs text-gray-600 dark:text-gray-400">
          <i class="fas fa-clock mr-1"></i>Ordenado por fecha estimada de agotamiento
        </div>
      </div>
    </div>

    <!-- Gráficos Secundarios (más pequeños) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 fade-in">
      <!-- Gráfico 3: Distribución Riesgo -->
      <div class="card p-6">
        <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-chart-pie text-orange-600 mr-2"></i>
          Distribución de Riesgos
        </h2>
        <!-- CONTENEDOR MÁS PEQUEÑO -->
        <div class="chart-container-sm">
          <canvas id="chartRiesgo"></canvas>
        </div>
      </div>

      <!-- Gráfico 4: Tendencias -->
      <div class="card p-6">
        <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-trend-up text-green-600 mr-2"></i>
          Tendencias Mensuales
        </h2>
        <!-- CONTENEDOR MÁS PEQUEÑO -->
        <div class="chart-container-sm">
          <canvas id="chartTendencias"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabla con Scroll Controlado -->
    <div class="card p-6 mb-8 fade-in">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-4">
        <i class="fas fa-bell text-red-600 pulse"></i>
        Medicamentos en Alerta Crítica
      </h2>
      
      <!-- Contenedor con scroll controlado -->
      <div class="overflow-x-auto scrollbar-thin" style="max-height: 500px;">
        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700">
          <thead class="bg-gradient-to-r from-red-700 to-rose-800 text-white sticky top-0">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Rank</th>
              <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Medicamento</th>
              <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider">Stock</th>
              <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider">Demanda /mes</th>
              <th class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider">Agotamiento</th>
              <th class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider">Estado</th>
              <th class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider">Acción</th>
            </tr>
          </thead>
          <tbody id="tablaPrediccion" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <!-- Datos cargados dinámicamente -->
          </tbody>
        </table>
      </div>
      
      <div class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
        <i class="fas fa-database mr-2"></i>Total registros: <span id="totalRegistros">0</span>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-10 pt-6 border-t border-gray-300 dark:border-gray-700 text-center text-gray-600 dark:text-gray-400 text-sm">
      <p>© 2025 IPS Intelligence System | Dashboard Predictivo v2.1</p>
      <p class="mt-2">Sistema de prevención proactiva de quiebres de stock</p>
    </footer>
  </div>

  <script>
    // Registrar plugins
    Chart.register(ChartDataLabels);
    const { DateTime } = luxon;

    // Estado global
    let data = { mensual: [], medicamentos: [], farmacias: [] };
    let filters = { farmacia: "", horizonte: 3, nivelRiesgo: "" };
    let charts = {};

    // Inicialización
    async function init() {
      try {
        // Simular carga de datos (en producción cargar desde JSON)
        await cargarDatosSimulados();
        
        // Actualizar fecha
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-PY', {
          year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        // Configurar listeners
        configurarEventListeners();
        
        // Actualizar todo
        actualizarTodo();
        
        console.log("Dashboard inicializado correctamente");
      } catch (err) {
        console.error("Error inicializando:", err);
        mostrarError("No se pudieron cargar los datos. Intente recargar la página.");
      }
    }

    async function cargarDatosSimulados() {
      // Datos mensuales simulados
      data.mensual = Array.from({length: 12}, (_, i) => ({
        año: 2025,
        mes: i + 1,
        total_recetado: Math.floor(50000 + Math.random() * 30000),
        total_dispensado: Math.floor(40000 + Math.random() * 25000)
      }));

      // Medicamentos simulados
      const nombresMedicamentos = [
        "ALCOHOL RECTIFICADO 96%",
        "ALCOHOL AL 70% SOLUCIÓN",
        "LOSARTAN POTASICO 50mg",
        "METFORMINA 850mg",
        "ATORVASTATINA 20mg",
        "ENALAPRIL 10mg",
        "IBUPROFENO 400mg",
        "PARACETAMOL 500mg",
        "OMEPRAZOL 20mg",
        "AMOXICILINA 500mg",
        "SALBUTAMOL INHALADOR",
        "INSULINA GLARGINA"
      ];

      data.medicamentos = nombresMedicamentos.map((nombre, idx) => ({
        TextoBreveMedicamento: nombre,
        recetado: Math.floor(10000 + Math.random() * 50000),
        dispensado: Math.floor(8000 + Math.random() * 40000),
        MedicamentoSAP: `MED${1000 + idx}`,
        tipo: ['cronico', 'agudo', 'alto_costo', 'generico'][Math.floor(Math.random() * 4)]
      }));

      // Farmacias simuladas
      data.farmacias = Array.from({length: 10}, (_, i) => ({
        FarmaciaVentanilla: `FV${100 + i}`,
        nombre: `Farmacia ${i + 1}`,
        total_recetado: Math.floor(10000 + Math.random() * 50000),
        total_dispensado: Math.floor(8000 + Math.random() * 40000)
      }));
    }

    function configurarEventListeners() {
      // Filtros
      document.getElementById('farmaciaFilter').addEventListener('change', e => {
        filters.farmacia = e.target.value;
        actualizarTodo();
      });
      
      document.getElementById('horizonte').addEventListener('change', e => {
        filters.horizonte = parseInt(e.target.value);
        actualizarTodo();
      });
      
      document.getElementById('nivelRiesgo').addEventListener('change', e => {
        filters.nivelRiesgo = e.target.value;
        actualizarTodo();
      });
      
      document.getElementById('btnReset').addEventListener('click', () => {
        filters = { farmacia: "", horizonte: 3, nivelRiesgo: "" };
        document.getElementById('farmaciaFilter').value = "";
        document.getElementById('horizonte').value = 3;
        document.getElementById('nivelRiesgo').value = "";
        actualizarTodo();
      });
      
      // Modo oscuro
      document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
      
      // Cargar filtro de farmacias
      const select = document.getElementById('farmaciaFilter');
      data.farmacias.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.FarmaciaVentanilla;
        opt.textContent = f.nombre || `Farmacia ${f.FarmaciaVentanilla}`;
        select.appendChild(opt);
      });
    }

    function actualizarTodo() {
      actualizarKPIs();
      actualizarGraficoPrediccion();
      actualizarGraficoQuiebreFuturo();
      actualizarGraficoRiesgo();
      actualizarGraficoTendencias();
      actualizarTablaPrediccion();
    }

    function actualizarKPIs() {
      let recetado = data.mensual.reduce((sum, m) => sum + m.total_recetado, 0);
      let dispensado = data.mensual.reduce((sum, m) => sum + m.total_dispensado, 0);
      let faltante = recetado - dispensado;
      let tasa = recetado > 0 ? (dispensado / recetado) * 100 : 0;
      
      if (filters.farmacia) {
        const farm = data.farmacias.find(f => f.FarmaciaVentanilla === filters.farmacia);
        if (farm) {
          recetado = farm.total_recetado;
          dispensado = farm.total_dispensado;
          faltante = recetado - dispensado;
          tasa = recetado > 0 ? (dispensado / recetado) * 100 : 0;
        }
      }
      
      const medicamentosCriticos = obtenerMedicamentosCriticos();
      const prediccion = predecirDemandaTotal(filters.horizonte);
      
      document.getElementById('kpiRecetado').textContent = formatearNumero(recetado);
      document.getElementById('kpiDispensado').textContent = formatearNumero(dispensado);
      document.getElementById('kpiFaltante').textContent = formatearNumero(faltante);
      document.getElementById('kpiPrediccion').textContent = formatearNumero(Math.round(prediccion.realista));
      document.getElementById('kpiQuiebres').textContent = medicamentosCriticos.length;
      document.getElementById('kpiTasa').textContent = tasa.toFixed(1) + '%';
    }

    function predecirDemandaTotal(meses) {
      const historico = data.mensual
        .filter(m => m.año === 2025)
        .map(m => ({ mes: m.mes, valor: m.total_recetado }));

      if (historico.length < 3) return { realista: 0, pesimista: 0, optimista: 0 };

      // Regresión lineal simple
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      const n = historico.length;
      
      historico.forEach((p, i) => {
        sumX += p.mes;
        sumY += p.valor;
        sumXY += p.mes * p.valor;
        sumX2 += p.mes * p.mes;
      });
      
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      
      const ultimoMes = historico[historico.length - 1].mes;
      const base = intercept + slope * (ultimoMes + meses);

      return {
        realista: base,
        pesimista: base * 1.25,
        optimista: base * 0.85
      };
    }

    function actualizarGraficoPrediccion() {
      const ctx = document.getElementById('chartPrediccion').getContext('2d');
      const hist = data.mensual.filter(m => m.año === 2025).sort((a,b) => a.mes - b.mes);
      const labelsHist = hist.map(m => DateTime.fromObject({year: 2025, month: m.mes}).toFormat('MMM'));
      const dataHist = hist.map(m => m.total_recetado);

      const pred = predecirDemandaTotal(filters.horizonte);
      const mesesFuturos = Array(filters.horizonte).fill(pred.realista);
      const labelsFut = Array.from({length: filters.horizonte}, (_, i) =>
        DateTime.fromObject({year: 2026, month: i+1}).toFormat('MMM'));

      if (charts.prediccion) charts.prediccion.destroy();

      // Configuración específica para contenedor fijo
      const options = {
        responsive: true,
        maintainAspectRatio: false, // IMPORTANTE: Permite que el gráfico se ajuste al contenedor
        plugins: {
          legend: { 
            position: 'top',
            labels: { font: { size: 11 } }
          },
          tooltip: { 
            mode: 'index', 
            intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.8)'
          }
        },
        scales: { 
          y: { 
            beginAtZero: false,
            ticks: { 
              callback: function(value) {
                return formatearNumero(value);
              },
              font: { size: 10 }
            },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          },
          x: {
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          }
        }
      };

      charts.prediccion = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [...labelsHist, ...labelsFut],
          datasets: [
            {
              label: '2025 Real',
              data: [...dataHist, ...Array(filters.horizonte).fill(null)],
              borderColor: '#4f46e5',
              backgroundColor: 'rgba(79, 70, 229, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true
            },
            {
              label: 'Predicción 2026',
              data: [...Array(hist.length).fill(null), ...mesesFuturos],
              borderColor: '#7c3aed',
              backgroundColor: 'rgba(124, 58, 237, 0.2)',
              borderDash: [6, 3],
              borderWidth: 2,
              tension: 0.4
            }
          ]
        },
        options: options
      });
    }

    function obtenerMedicamentosCriticos() {
      const aggregated = {};
      data.medicamentos.forEach(item => {
        const key = item.TextoBreveMedicamento;
        if (!aggregated[key]) aggregated[key] = { rec: 0, disp: 0 };
        aggregated[key].rec += item.recetado;
        aggregated[key].disp += item.dispensado;
      });

      const medicamentos = Object.entries(aggregated)
        .map(([med, v]) => {
          const tasa = v.rec > 0 ? v.disp / v.rec : 0;
          const demandaMensual = Math.round(v.rec / 12);
          const stockActual = v.disp;
          const mesesRestantes = demandaMensual > 0 ? stockActual / demandaMensual : 0;
          
          let nivelRiesgo = 'bajo';
          if (mesesRestantes < 2) nivelRiesgo = 'critico';
          else if (mesesRestantes < 4) nivelRiesgo = 'alto';
          else if (mesesRestantes < 6) nivelRiesgo = 'medio';
          
          // Filtrar por nivel de riesgo si está activo
          if (filters.nivelRiesgo && nivelRiesgo !== filters.nivelRiesgo) {
            return null;
          }
          
          const fechaAgotamiento = DateTime.now().plus({ months: Math.max(0.5, mesesRestantes) });
          
          return {
            medicamento: med,
            stock: stockActual,
            demandaMensual: demandaMensual,
            mesesRestantes: mesesRestantes,
            fechaAgotamiento: fechaAgotamiento,
            mesTexto: fechaAgotamiento.toFormat('MMM yyyy'),
            nivelRiesgo: nivelRiesgo,
            accionRecomendada: mesesRestantes < 2 ? 'COMPRAR HOY' : 
                             mesesRestantes < 4 ? 'PLANIFICAR COMPRA' : 
                             'MONITOREAR'
          };
        })
        .filter(m => m && m.mesesRestantes < 12)
        .sort((a, b) => a.mesesRestantes - b.mesesRestantes);
      
      return medicamentos;
    }

    function actualizarGraficoQuiebreFuturo() {
      const ctx = document.getElementById('chartQuiebreFuturo').getContext('2d');
      const criticos = obtenerMedicamentosCriticos().slice(0, 10);

      if (charts.quiebre) charts.quiebre.destroy();

      charts.quiebre = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: criticos.map(c => c.medicamento.substring(0, 20) + (c.medicamento.length > 20 ? '...' : '')),
          datasets: [{
            label: 'Meses hasta agotarse',
            data: criticos.map(c => c.mesesRestantes),
            backgroundColor: criticos.map(c => {
              if (c.mesesRestantes < 2) return '#dc2626';
              if (c.mesesRestantes < 4) return '#f59e0b';
              return '#3b82f6';
            }),
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false, // IMPORTANTE: Ajusta al contenedor
          plugins: {
            legend: { display: false },
            datalabels: {
              color: 'white',
              font: { weight: 'bold', size: 10 },
              formatter: (value) => value < 1 ? '< 1 mes' : value.toFixed(1) + ' meses',
              anchor: 'end',
              align: 'right'
            }
          },
          scales: {
            x: { 
              beginAtZero: true,
              ticks: { 
                callback: function(value) {
                  return value + ' meses';
                },
                font: { size: 10 }
              }
            },
            y: {
              ticks: { font: { size: 10 } }
            }
          }
        }
      });
    }

    function actualizarGraficoRiesgo() {
      const ctx = document.getElementById('chartRiesgo').getContext('2d');
      const criticos = obtenerMedicamentosCriticos();
      
      const niveles = {
        critico: criticos.filter(m => m.nivelRiesgo === 'critico').length,
        alto: criticos.filter(m => m.nivelRiesgo === 'alto').length,
        medio: criticos.filter(m => m.nivelRiesgo === 'medio').length,
        bajo: criticos.filter(m => m.nivelRiesgo === 'bajo').length
      };

      if (charts.riesgo) charts.riesgo.destroy();

      charts.riesgo = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Crítico', 'Alto', 'Medio', 'Bajo'],
          datasets: [{
            data: [niveles.critico, niveles.alto, niveles.medio, niveles.bajo],
            backgroundColor: ['#dc2626', '#f59e0b', '#3b82f6', '#10b981'],
            borderWidth: 2,
            borderColor: 'white'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // IMPORTANTE: Ajusta al contenedor
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { 
                padding: 15,
                font: { size: 11 }
              }
            }
          },
          cutout: '65%'
        }
      });
    }

    function actualizarGraficoTendencias() {
      const ctx = document.getElementById('chartTendencias').getContext('2d');
      const hist = data.mensual.filter(m => m.año === 2025).sort((a,b) => a.mes - b.mes);
      
      if (charts.tendencias) charts.tendencias.destroy();

      charts.tendencias = new Chart(ctx, {
        type: 'line',
        data: {
          labels: hist.map(m => DateTime.fromObject({year: 2025, month: m.mes}).toFormat('MMM')),
          datasets: [
            {
              label: 'Recetado',
              data: hist.map(m => m.total_recetado),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: 'Dispensado',
              data: hist.map(m => m.total_dispensado),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // IMPORTANTE: Ajusta al contenedor
          plugins: {
            legend: { 
              position: 'top',
              labels: { font: { size: 11 } }
            }
          },
          scales: {
            y: { 
              beginAtZero: false,
              ticks: { font: { size: 10 } }
            },
            x: {
              ticks: { font: { size: 10 } }
            }
          }
        }
      });
    }

    function actualizarTablaPrediccion() {
      const tbody = document.getElementById('tablaPrediccion');
      const medicamentos = obtenerMedicamentosCriticos();
      
      tbody.innerHTML = '';
      
      medicamentos.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.className = i % 2 === 0 ? 'bg-gray-50 dark:bg-gray-900/50' : '';
        
        let colorClase = '';
        let badgeClase = '';
        if (item.nivelRiesgo === 'critico') {
          colorClase = 'text-red-700 dark:text-red-300';
          badgeClase = 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300';
        } else if (item.nivelRiesgo === 'alto') {
          colorClase = 'text-orange-700 dark:text-orange-300';
          badgeClase = 'bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300';
        } else {
          colorClase = 'text-blue-700 dark:text-blue-300';
          badgeClase = 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300';
        }
        
        tr.innerHTML = `
          <td class="px-4 py-3 font-bold ${colorClase}">${i+1}</td>
          <td class="px-4 py-3 font-medium text-gray-800 dark:text-gray-200">${item.medicamento}</td>
          <td class="px-4 py-3 text-right font-mono">${formatearNumero(item.stock)}</td>
          <td class="px-4 py-3 text-right font-mono">${formatearNumero(item.demandaMensual)}</td>
          <td class="px-4 py-3 text-center font-bold ${colorClase}">${item.mesTexto}</td>
          <td class="px-4 py-3 text-center">
            <span class="px-2 py-1 rounded-full text-xs font-bold ${badgeClase}">
              ${item.nivelRiesgo.toUpperCase()}
            </span>
          </td>
          <td class="px-4 py-3 text-center">
            <span class="px-3 py-1 rounded-full text-xs font-bold ${
              item.nivelRiesgo === 'critico' ? 'bg-red-600 text-white' :
              item.nivelRiesgo === 'alto' ? 'bg-orange-600 text-white' :
              'bg-blue-600 text-white'
            }">
              ${item.accionRecomendada}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('totalRegistros').textContent = medicamentos.length;
    }

    function toggleDarkMode() {
      const html = document.documentElement;
      const btn = document.getElementById('darkModeToggle');
      
      html.classList.toggle('dark');
      
      if (html.classList.contains('dark')) {
        btn.innerHTML = '<i class="fas fa-sun text-yellow-300"></i>';
        localStorage.setItem('darkMode', 'true');
      } else {
        btn.innerHTML = '<i class="fas fa-moon text-gray-600"></i>';
        localStorage.setItem('darkMode', 'false');
      }
      
      // Recrear gráficos con nuevo tema
      setTimeout(() => {
        actualizarGraficoPrediccion();
        actualizarGraficoQuiebreFuturo();
        actualizarGraficoRiesgo();
        actualizarGraficoTendencias();
      }, 100);
    }

    function formatearNumero(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toLocaleString('es-ES');
    }

    function mostrarError(mensaje) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg z-50';
      errorDiv.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle mr-3"></i>
          <span>${mensaje}</span>
        </div>
      `;
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Cargar modo oscuro guardado
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.classList.add('dark');
      document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun text-yellow-300"></i>';
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
