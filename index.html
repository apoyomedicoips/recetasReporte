<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Recetas 2025 + Predicción 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root { --critical: #dc2626; --warning: #f59e0b; --good: #10b981; --predict: #7c3aed; }
    .card { @apply bg-white rounded-2xl shadow-xl border border-gray-100 transition-all hover:shadow-2xl; }
    .badge { @apply px-3 py-1 rounded-full text-xs font-bold; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl">

    <header class="mb-10 text-center">
      <h1 class="text-5xl font-bold text-indigo-900 mb-3 flex items-center justify-center gap-3">
        <i class="fas fa-crystal-ball"></i> Dashboard + Predicción 2026
      </h1>
      <p class="text-xl text-gray-600">Detección temprana de quiebres de stock con IA ligera</p>
      <div class="mt-4 text-sm text-gray-500">
        Actualizado: <span id="lastUpdate" class="font-semibold text-indigo-700">-</span>
      </div>
    </header>

    <!-- Filtros -->
    <div class="card mb-8 p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Farmacia</label>
          <select id="farmaciaFilter" class="w-full px-4 py-3 border rounded-xl focus:ring-4 focus:ring-indigo-300">
            <option value="">Todas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Año Base</label>
          <select id="anioFilter" class="w-full px-4 py-3 border rounded-xl">
            <option value="2025" selected>2025</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Horizonte Predicción</label>
          <select id="horizonte" class="w-full px-4 py-3 border rounded-xl">
            <option value="3">3 meses (Mar 2026)</option>
            <option value="6">6 meses (Jun 2026)</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btnReset" class="w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg">
            <i class="fas fa-sync-alt mr-2"></i> Reiniciar
          </button>
        </div>
      </div>
    </div>

    <!-- KPIs + Predicción -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
      <div class="card bg-gradient-to-br from-blue-600 to-blue-800 text-white">
        <h3 class="text-lg font-semibold">Recetado 2025</h3>
        <p class="text-4xl font-bold mt-2" id="kpiRecetado">0</p>
      </div>
      <div class="card bg-gradient-to-br from-emerald-600 to-emerald-800 text-white">
        <h3 class="text-lg font-semibold">Dispensado</h3>
        <p class="text-4xl font-bold mt-2" id="kpiDispensado">0</p>
      </div>
      <div class="card bg-gradient-to-br from-red-600 to-red-800 text-white">
        <h3 class="text-lg font-semibold">Faltante Actual</h3>
        <p class="text-4xl font-bold mt-2" id="kpiFaltante">0</p>
      </div>
      <div class="card bg-gradient-to-br from-purple-600 to-violet-800 text-white">
        <h3 class="text-lg font-semibold">Predicción Mar 2026</h3>
        <p class="text-4xl font-bold mt-2" id="kpiPrediccion">0</p>
      </div>
      <div class="card bg-gradient-to-br from-orange-600 to-amber-700 text-white">
        <h3 class="text-lg font-semibold">Quiebres Estimados</h3>
        <p class="text-4xl font-bold mt-2" id="kpiQuiebres">0</p>
      </div>
      <div class="card bg-gradient-to-br from-pink-600 to-rose-700 text-white">
        <h3 class="text-lg font-semibold">Tasa Actual</h3>
        <p class="text-4xl font-bold mt-2" id="kpiTasa">0%</p>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
      <div class="card p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
          Evolución + Predicción Inteligente
        </h2>
        <canvas id="chartPrediccion"></canvas>
      </div>
      <div class="card p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
          Top 10: Se agotarán primero (2026)
        </h2>
        <canvas id="chartQuiebreFuturo"></canvas>
      </div>
    </div>

    <!-- Tabla de predicción crítica -->
    <div class="card p-8">
      <h2 class="text-3xl font-bold text-gray-800 mb-8 flex items-center gap-4">
        <i class="fas fa-exclamation-triangle text-red-600 animate-pulse"></i>
        Medicamentos que se agotarán en los próximos meses
      </h2>
      <div class="overflow-x-auto rounded-xl border border-gray-200">
        <table class="min-w-full divide-y divide-gray-300">
          <thead class="bg-gradient-to-r from-red-700 to-rose-800 text-white">
            <tr>
              <th class="px-6 py-4 text-left text-sm font-bold uppercase">Rank</th>
              <th class="px-6 py-4 text-left text-sm font-bold uppercase">Medicamento</th>
              <th class="px-6 py-4 text-right text-sm font-bold uppercase">Stock Actual</th>
              <th class="px-6 py-4 text-right text-sm font-bold uppercase">Demanda Predicha</th>
              <th class="px-6 py-4 text-right text-sm font-bold uppercase">Mes de Agotamiento</th>
              <th class="px-6 py-4 text-center text-sm font-bold uppercase">Acción</th>
            </tr>
          </thead>
          <tbody id="tablaPrediccion" class="bg-white divide-y divide-gray-200">
          </tbody>
        </table>
      </div>
    </div>

    <footer class="mt-16 text-center text-gray-500 text-sm">
      <p>Predicción basada en regresión exponencial + estacionalidad | Modelo actualizado diariamente</p>
    </footer>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    const dt = luxon.DateTime;

    let data = { mensual: [], medicamentos: [], farmacias: [] };
    let filters = { farmacia: "", anio: "2025", horizonte: 3 };
    let chartPrediccion, chartQuiebreFuturo;

    async function init() {
      const [mensual, meds, farms] = await Promise.all([
        fetch('resumen_mensual.json').then(r => r.json()),
        fetch('top_medicamentos.json').then(r => r.json()),
        fetch('top_farmacias.json').then(r => r.json())
      ]);
      data = { mensual, medicamentos: meds, farmacias: farms };
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-PY');

      populateFarmacias();
      setupEvents();
      updateAll();
    }

    function populateFarmacias() {
      const select = document.getElementById('farmaciaFilter');
      [...new Set(data.farmacias.map(f => f.FarmaciaVentanilla))].sort().forEach(id => {
        select.add(new Option(`Farmacia ${id}`, id));
      });
    }

    function setupEvents() {
      document.getElementById('farmaciaFilter').onchange = e => { filters.farmacia = e.target.value; updateAll(); };
      document.getElementById('horizonte').onchange = e => { filters.horizonte = parseInt(e.target.value); updateAll(); };
      document.getElementById('btnReset').onclick = () => {
        filters = { farmacia: "", anio: "2025", horizonte: 3 };
        document.getElementById('farmaciaFilter').value = "";
        document.getElementById('horizonte').value = 3;
        updateAll();
      };
    }

    function updateAll() {
      updateKPIs();
      updateChartPrediccion();
      updateChartQuiebreFuturo();
      updateTablaPrediccion();
    }

    function updateKPIs() {
      let recetado = 0, dispensado = 0;
      data.mensual.filter(m => m.año === 2025).forEach(m => {
        recetado += m.total_recetado;
        dispensado += m.total_dispensado;
      });

      if (filters.farmacia) {
        const f = data.farmacias.find(x => x.FarmaciaVentanilla === filters.farmacia);
        if (f) { recetado = f.total_recetado; dispensado = f.total_dispensado; }
      }

      const prediccion = predecirDemandaTotal(filters.horizonte);
      const quiebres = getPrediccionCritica().length;

      document.getElementById('kpiRecetado').textContent = recetado.toLocaleString();
      document.getElementById('kpiDispensado').textContent = dispensado.toLocaleString();
      document.getElementById('kpiFaltante').textContent = (recetado - dispensado).toLocaleString();
      document.getElementById('kpiPrediccion').textContent = Math.round(prediccion.realista).toLocaleString();
      document.getElementById('kpiQuiebres').textContent = quiebres;
      document.getElementById('kpiTasa').textContent = dispensado > 0 ? ((dispensado/recetado)*100).toFixed(1)+'%' : '0%';
    }

    function predecirDemandaTotal(meses) {
      const historico = data.mensual
        .filter(m => m.año === 2025)
        .map(m => ({ mes: m.mes, demanda: m.total_recetado }));

      if (historico.length < 6) return { realista: 0, pesimista: 0, optimista: 0 };

      // Tendencia lineal ponderada (más peso a meses recientes)
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, weightSum = 0;
      historico.forEach((p, i) => {
        const w = i + 1;
        sumX += p.mes * w;
        sumY += p.demanda * w;
        sumXY += p.mes * p.demanda * w;
        sumX2 += p.mes * p.mes * w;
        weightSum += w;
      });

      const slope = (weightSum * sumXY - sumX * sumY) / (weightSum * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / weightSum;

      const ultimoMes = 12;
      const proyeccionBase = intercept + slope * (ultimoMes + meses);

      return {
        realista: proyeccionBase,
        pesimista: proyeccionBase * 1.20,
        optimista: proyeccionBase * 0.90
      };
    }

    function updateChartPrediccion() {
      const ctx = document.getElementById('chartPrediccion').getContext('2d');
      const hist = data.mensual.filter(m => m.año === 2025).sort((a,b) => a.mes - b.mes);

      const labelsHist = hist.map(m => dt.fromObject({year:2025, month:m.mes}).toFormat('MMM'));
      const recetadoHist = hist.map(m => m.total_recetado);

      // Predicción
      const mesesFuturos = filters.horizonte;
      const prediccion = predecirDemandaTotal(mesesFuturos);
      const labelsPred = Array.from({length: mesesFuturos}, (_, i) => 
        dt.fromObject({year:2026, month: i+1}).toFormat('MMM'));

      if (chartPrediccion) chartPrediccion.destroy();
      chartPrediccion = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [...labelsHist, ...labelsPred],
          datasets: [
            { label: '2025 Real', data: [...recetadoHist, ...Array(mesesFuturos).fill(null)], borderColor: '#4f46e5', tension: 0.4 },
            { label: 'Predicción Realista', data: [...Array(hist.length).fill(null), prediccion.realista], borderColor: '#7c3aed', borderDash: [5,5], pointStyle: 'triangle' },
            { label: 'Pesimista (+20%)', data: [...Array(hist.length).fill(null), prediccion.pesimista], borderColor: '#dc2626', borderDash: [10,5] },
            { label: 'Optimista (-10%)', data: [...Array(hist.length).fill(null), prediccion.optimista], borderColor: '#10b981', borderDash: [10,5] }
          ]
        },
        options: {
          responsive: true,
          plugins: { 
            title: { display: true, text: 'Predicción de Demanda Total', font: {size: 16} },
            datalabels: { display: false }
          }
        }
      });
    }

    function getPrediccionCritica() {
      const agg = {};
      data.medicamentos.forEach(m => {
        if (!agg[m.TextoBreveMedicamento]) {
          agg[m.TextoBreveMedicamento] = { rec: 0, disp: 0 };
        }
        agg[m.TextoBreveMedicamento].rec += m.recetado;
        agg[m.TextoBreveMedicamento].disp += m.dispensado;
      });

      return Object.entries(agg)
        .map(([med, v]) => {
          const tasa = v.disp / v.rec;
          const mesesParaAgotar = tasa > 0 ? (v.disp / v.rec) * 12 : 1; // estimación burda
          return {
            medicamento: med,
            stock: v.disp,
            demandaMensual: v.rec / 12,
            mesesRestantes: mesesParaAgotar,
            mesAgotamiento: dt.now().plus({months: Math.max(1, Math.round(mesesRestantes))}).toFormat('MMM yyyy')
          };
        })
        .filter(x => x.mesesRestantes < 6)
        .sort((a,b) => a.mesesRestantes - b.mesesRestantes)
        .slice(0, 20);
    }

    function updateChartQuiebreFuturo() {
      const ctx = document.getElementById('chartQuiebreFuturo').getContext('2d');
      const criticos = getPrediccionCritica().slice(0,10);

      if (chartQuiebreFuturo) chartQuiebreFuturo.destroy();
      chartQuiebreFuturo = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: criticos.map(c => c.medicamento.substring(0,35)+'...'),
          datasets: [{
            label: 'Meses hasta agotarse',
            data: criticos.map(c => c.mesesRestantes),
            backgroundColor: criticos.map(c => c.mesesRestantes < 2 ? '#dc2626' : '#f59e0b')
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: {
            datalabels: {
              color: 'white',
              font: {weight: 'bold'},
              formatter: v => v.toFixed(1) + ' mes'
            }
          }
        }
      });
    }

    function updateTablaPrediccion() {
      const tbody = document.getElementById('tablaPrediccion');
      tbody.innerHTML = '';
      getPrediccionCritica().forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.className = i % 2 === 0 ? 'bg-red-50' : 'bg-white';
        tr.innerHTML = `
          <td class="px-6 py-4 font-bold text-2xl text-red-700">#${i+1}</td>
          <td class="px-6 py-4 font-medium">${item.medicamento}</td>
          <td class="px-6 py-4 text-right">${item.stock.toLocaleString()}</td>
          <td class="px-6 py-4 text-right font-bold">${Math.round(item.demandaMensual).toLocaleString()}</td>
          <td class="px-6 py-4 text-center text-lg font-bold text-red-600">${item.mesAgotamiento}</td>
          <td class="px-6 py-4 text-center">
            <span class="badge ${item.mesesRestantes < 2 ? 'bg-red-700 text-white' : 'bg-orange-600 text-white'}">
              COMPRAR YA
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    init();
  </script>
</body>
</html>
