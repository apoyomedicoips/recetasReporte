<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPS | IA Predictiva 2026 - Tablero Interactivo</title>
  
  <!-- Tailwind + Chart.js + Luxon + SheetJS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Tippy.js + Popper (tooltips hermosos) -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <style>
    body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; font-family: 'Inter', system-ui; }
    .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.2); }
    .card-hover { transition: all 0.3s; }
    .card-hover:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .metric { font-size: 3rem; font-weight: 900; }
    .tooltip { @apply bg-slate-900 text-white text-xs rounded-lg shadow-2xl border border-slate-700; }
    .risk-critical { @apply bg-red-600/20 text-red-300 border-red-600/50; }
    .risk-high { @apply bg-orange-600/20 text-orange-300 border-orange-600/50; }
    .risk-medium { @apply bg-yellow-600/20 text-yellow-300 border-yellow-600/50; }
  </style>
</head>
<body class="min-h-screen">

  <div class="container mx-auto p-6 max-w-7xl">

    <!-- Header Premium -->
    <header class="glass rounded-3xl p-10 mb-10 shadow-2xl text-center card-hover">
      <h1 class="text-6xl font-bold text-white mb-4 drop-shadow-lg">
        <i class="fas fa-brain text-purple-400 animate-pulse"></i> IPS IA Predictiva
      </h1>
      <p class="text-2xl text-slate-300">Predicción de Demanda 2026 con Machine Learning</p>
      <p class="text-lg text-slate-400 mt-4">Intervalos de confianza • Alertas automáticas • 100% interactivo</p>
      <div class="mt-6 text-sm">
        <span class="text-slate-400">Actualizado:</span> 
        <span id="lastUpdate" class="font-bold text-cyan-400">—</span>
      </div>
    </header>

    <!-- Filtros Interactivos -->
    <div class="glass rounded-2xl p-8 mb-10 shadow-2xl card-hover">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
          <label class="text-sm font-bold text-slate-300 mb-3 block">Farmacia</label>
          <select id="farmaciaFilter" class="w-full px-6 py-4 bg-slate-800/50 border border-slate-600 rounded-xl text-white focus:ring-4 focus:ring-purple-500 focus:border-purple-500 transition">
            <option value="">Todas las sedes</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-bold text-slate-300 mb-3 block">Nivel de Riesgo</label>
          <select id="riesgoFilter" class="w-full px-6 py-4 bg-slate-800/50 border border-slate-600 rounded-xl text-white focus:ring-4 focus:ring-purple-500">
            <option value="TODOS">Todos los medicamentos</option>
            <option value="CRÍTICO">Solo Críticos</option>
            <option value="ALTO">Crítico + Alto</option>
            <option value="MEDIO">Todos con riesgo</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btnExport" class="w-full px-8 py-5 bg-gradient-to-r from-emerald-500 to-cyan-600 text-white font-bold rounded-xl shadow-2xl hover:from-emerald-600 hover:to-cyan-700 transition flex items-center justify-center gap-4 text-lg">
            <i class="fas fa-file-excel"></i>
            <span>Exportar Informe</span>
          </button>
        </div>
      </div>
    </div>

    <!-- KPIs con Hover -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-10">
      <div class="glass p-8 rounded-2xl card-hover border-l-8 border-cyan-500" data-tippy-content="Nivel de Servicio Global (OTIF)<br>Meta institucional: ≥90%">
        <p class="text-slate-400 text-sm font-bold uppercase">Nivel de Servicio</p>
        <p class="metric text-cyan-400" id="kpiServicio">--%</p>
      </div>
      <div class="glass p-8 rounded-2xl card-hover border-l-8 border-red-500" data-tippy-content="Unidades recetadas pero no dispensadas<br>Impacto directo en el paciente">
        <p class="text-slate-400 text-sm font-bold uppercase">Déficit Crítico</p>
        <p class="metric text-red-400" id="kpiDeficit">0</p>
      </div>
      <div class="glass p-8 rounded-2xl card-hover border-l-8 border-purple-500" data-tippy-content="Pronóstico total Ene-Jun 2026<br>Modelo híbrido Prophet + XGBoost">
        <p class="text-slate-400 text-sm font-bold uppercase">Pronóstico 2026</p>
        <p class="metric text-purple-400" id="kpiPronostico">0</p>
      </div>
      <div class="glass p-8 rounded-2xl card-hover border-l-8 border-orange-500" data-tippy-content="Medicamentos con probabilidad >60% de quiebre">
        <p class="text-slate-400 text-sm font-bold uppercase">En Riesgo</p>
        <p class="metric text-orange-400" id="kpiRiesgo">0</p>
      </div>
    </div>

    <!-- Gráfico Principal con Tooltip Avanzado -->
    <div class="glass p-10 rounded-3xl mb-10 shadow-2xl card-hover">
      <h3 class="text-3xl font-bold text-white mb-8 text-center">
        Predicción Global con Bandas de Confianza
      </h3>
      <canvas id="chartGlobal" height="420"></canvas>
      <div class="flex justify-center gap-10 mt-8 text-sm">
        <span><i class="fas fa-circle text-purple-400"></i> Pronóstico</span>
        <span><i class="fas fa-circle text-purple-400 opacity-60"></i> 80% Confianza</span>
        <span><i class="fas fa-circle text-purple-400 opacity-40"></i> 95% Confianza</span>
      </div>
    </div>

    <!-- Tabla Interactiva con Tooltips -->
    <div class="glass p-10 rounded-3xl">
      <h3 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
        Medicamentos Críticos 2026
      </h3>
      <div class="overflow-x-auto rounded-2xl border border-slate-700">
        <table class="w-full text-sm">
          <thead class="bg-gradient-to-r from-purple-900 to-slate-900 text-white">
            <tr>
              <th class="px-6 py-5 text-left">Rank</th>
              <th class="px-6 py-5 text-left">Medicamento</th>
              <th class="px-6 py-5 text-right">2025</th>
              <th class="px-6 py-5 text-right">2026</th>
              <th class="px-6 py-5 text-center">Crecimiento</th>
              <th class="px-6 py-5 text-center">80% Confianza</th>
              <th class="px-6 py-5 text-center">Riesgo</th>
              <th class="px-6 py-5 text-center">Acción</th>
            </tr>
          </thead>
          <tbody id="tablaPredicciones" class="divide-y divide-slate-700"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const { DateTime } = luxon;
    Chart.register(ChartDataLabels);

    let data = { mensual: [], prediccion: [], farmacias: [] };
    let filters = { farmacia: "", riesgo: "TODOS" };
    let chartGlobal = null;

    async function init() {
      try {
        const [mensual, prediccion, farmacias] = await Promise.all([
          fetch('resumen_mensual.json').then(r => r.json()),
          fetch('prediccion_ml_2026.json').then(r => r.json()),
          fetch('top_farmacias.json').then(r => r.json())
        ]);
        data = { mensual, prediccion, farmacias };
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-PY');

        populateFarmacias();
        setupEvents();
        initTooltips();
        updateAll();
      } catch (e) {
        console.error(e);
        alert("Error: Verifica que prediccion_ml_2026.json exista");
      }
    }

    function populateFarmacias() {
      const sel = document.getElementById('farmaciaFilter');
      data.farmacias.forEach(f => sel.add(new Option(`Farmacia ${f.FarmaciaVentanilla}`, f.FarmaciaVentanilla)));
    }

    function setupEvents() {
      document.getElementById('farmaciaFilter').onchange = e => { filters.farmacia = e.target.value; updateAll(); };
      document.getElementById('riesgoFilter').onchange = e => { filters.riesgo = e.target.value; updateAll(); };
      document.getElementById('btnExport').onclick = exportarExcel;
    }

    function initTooltips() {
      tippy('[data-tippy-content]', {
        theme: 'light',
        animation: 'scale',
        allowHTML: true,
        placement: 'top'
      });
    }

    function updateAll() {
      updateKPIs();
      updateChartGlobal();
      updateTabla();
    }

    function updateKPIs() {
      const total2025 = data.mensual.reduce((s, m) => s + m.total_recetado, 0);
      const totalDisp = data.mensual.reduce((s, m) => s + m.total_dispensado, 0);
      const pronostico = data.prediccion.reduce((s, p) => s + p.pronostico_ene_jun_2026, 0);
      const criticos = data.prediccion.filter(p => p.nivel_riesgo === "CRÍTICO").length;

      document.getElementById('kpiServicio').textContent = total2025 > 0 ? ((totalDisp / total2025) * 100).toFixed(1) + '%' : '0%';
      document.getElementById('kpiDeficit').textContent = (total2025 - totalDisp).toLocaleString();
      document.getElementById('kpiPronostico').textContent = Math.round(pronostico).toLocaleString();
      document.getElementById('kpiRiesgo').textContent = criticos;
    }

    function updateChartGlobal() {
      const ctx = document.getElementById('chartGlobal').getContext('2d');
      const hist = data.mensual.sort((a,b) => a.mes - b.mes);
      const labels = hist.map(m => DateTime.fromObject({year: m.año, month: m.mes}).toFormat('MMM yyyy'));
      const real = hist.map(m => m.total_recetado);

      const totalPron = data.prediccion.reduce((s, p) => s + p.pronostico_ene_jun_2026, 0);
      const inf80 = data.prediccion.reduce((s, p) => s + p.intervalo_80_inf, 0);
      const sup80 = data.prediccion.reduce((s, p) => s + p.intervalo_80_sup, 0);

      if (chartGlobal) chartGlobal.destroy();
      chartGlobal = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [...labels, "Ene-Jun 2026"],
          datasets: [
            { label: 'Demanda Real', data: [...real, null], borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.1)', tension: 0.4, fill: true },
            { label: 'Pronóstico IA', data: [...Array(real.length).fill(null), totalPron], borderColor: '#a855f7', borderWidth: 5 },
            { label: '', data: [...Array(real.length).fill(null), inf80], borderColor: '#c084fc', borderDash: [8,8], fill: '+1' },
            { label: '80% Confianza', data: [...Array(real.length).fill(null), sup80], borderColor: '#c084fc', borderDash: [8,8], fill: '-1', backgroundColor: 'rgba(192,132,252,0.2)' }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            tooltip: {
              callbacks: {
                afterLabel: ctx => ctx.datasetIndex === 1 ? `80% confianza: ${inf80.toLocaleString()} - ${sup80.toLocaleString()}` : ''
              }
            }
          }
        }
      });
    }

    function updateTabla() {
      const tbody = document.getElementById('tablaPredicciones');
      tbody.innerHTML = '';
      let filtered = data.prediccion;

      if (filters.riesgo === "CRÍTICO") filtered = filtered.filter(p => p.nivel_riesgo === "CRÍTICO");
      if (filters.riesgo === "ALTO") filtered = filtered.filter(p => ["CRÍTICO","ALTO"].includes(p.nivel_riesgo));
      if (filters.riesgo === "MEDIO") filtered = filtered.filter(p => p.nivel_riesgo !== "BAJO");

      filtered.forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/10 transition cursor-pointer';
        tr.setAttribute('data-tippy-content', `
          <div class="p-3">
            <strong>${p.nombre_medicamento}</strong><br>
            Pronóstico: <strong>${p.pronostico_ene_jun_2026.toLocaleString()}</strong><br>
            80% confianza: ${p.intervalo_80_inf.toLocaleString()} - ${p.intervalo_80_sup.toLocaleString()}<br>
            95% confianza: ${p.intervalo_95_inf.toLocaleString()} - ${p.intervalo_95_sup.toLocaleString()}<br>
            <em class="text-yellow-300">${p.recomendacion}</em>
          </div>
        `);
        const clase = p.nivel_riesgo === "CRÍTICO" ? 'risk-critical' : p.nivel_riesgo === "ALTO" ? 'risk-high' : 'risk-medium';
        tr.innerHTML = `
          <td class="px-6 py-5 font-bold text-2xl text-cyan-400">#${i+1}</td>
          <td class="px-6 py-5 font-medium text-white">${p.nombre_medicamento}</td>
          <td class="px-6 py-5 text-right text-slate-300">${p.demanda_historica_total.toLocaleString()}</td>
          <td class="px-6 py-5 text-right font-bold text-purple-400">${p.pronostico_ene_jun_2026.toLocaleString()}</td>
          <td class="px-6 py-5 text-center text-green-400 font-bold">+${p.crecimiento_esperado_%}%</td>
          <td class="px-6 py-5 text-center text-xs text-slate-400">${p.intervalo_80_inf.toLocaleString()} - ${p.intervalo_80_sup.toLocaleString()}</td>
          <td class="px-6 py-5 text-center"><span class="px-5 py-3 rounded-full font-bold ${clase}">${p.probabilidad_quiebre_alto_%}%</span></td>
          <td class="px-6 py-5 text-center"><span class="px-6 py-3 rounded-full text-white font-bold ${p.nivel_riesgo === 'CRÍTICO' ? 'bg-red-600' : 'bg-orange-600'} animate-pulse">${p.recomendacion}</span></td>
        `;
        tbody.appendChild(tr);
      });

      // Reactivar tooltips después de actualizar tabla
      tippy('[data-tippy-content]', { allowHTML: true, animation: 'scale', theme: 'light' });
    }

    function exportarExcel() {
      const wb = XLSX.utils.book_new();
      const hoja = data.prediccion.map(p => ({
        Rank: p.rank,
        Medicamento: p.nombre_medicamento,
        "Demanda 2025": p.demanda_historica_total,
        "Pronóstico 2026": p.pronostico_ene_jun_2026,
        "Crecimiento %": p.crecimiento_esperado_%,
        "80% Inf": p.intervalo_80_inf,
        "80% Sup": p.intervalo_80_sup,
        "95% Inf": p.intervalo_95_inf,
        "95% Sup": p.intervalo_95_sup,
        "Probabilidad Quiebre": p.probabilidad_quiebre_alto_%,
        Recomendación: p.recomendacion,
        Riesgo: p.nivel_riesgo
      }));
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(hoja), "IA Predictiva 2026");
      XLSX.writeFile(wb, `IPS_IA_Predictiva_2026_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    init();
  </script>
</body>
</html>
