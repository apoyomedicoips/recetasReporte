<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IPS | Dashboard Predictivo 2025-2026</title>
  
  <!-- Tailwind + Chart.js + Luxon + Excel Export -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root { --critical: #dc2626; --warning: #f59e0b; --good: #10b981; --predict: #7c3aed; }
    body { font-family: 'Inter', system-ui; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
    .card { @apply bg-white rounded-2xl shadow-xl border border-gray-100 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 overflow-hidden; }
    .chart-container { position: relative; height: 350px; width: 100%; overflow: hidden; }
    .chart-container-sm { position: relative; height: 250px; width: 100%; overflow: hidden; }
    canvas { max-height: 100% !important; max-width: 100% !important; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
    .fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .dark body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    .dark .card { @apply bg-gray-800 border-gray-700; }
  </style>
</head>
<body>
  <div class="fixed top-4 right-4 z-50">
    <button id="darkModeToggle" class="p-3 bg-white dark:bg-gray-800 rounded-full shadow-lg hover:shadow-xl transition">
      <i class="fas fa-moon text-gray-600 dark:text-yellow-300"></i>
    </button>
  </div>

  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <header class="text-center mb-10 fade-in">
      <h1 class="text-5xl font-bold text-indigo-900 dark:text-white mb-4 flex items-center justify-center gap-4">
        <i class="fas fa-brain text-purple-600 dark:text-purple-400"></i>
        Dashboard Predictivo IPS 2025-2026
      </h1>
      <p class="text-xl text-gray-700 dark:text-gray-300">Sistema de Inteligencia para Prevención de Quiebres</p>
      <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
        Última actualización: <span id="lastUpdate" class="font-bold text-indigo-700 dark:text-indigo-300">Cargando...</span>
      </div>
    </header>

    <div class="card mb-8 p-6 fade-in">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Farmacia</label>
          <select id="farmaciaFilter" class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-300">
            <option value="">Todas</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Horizonte</label>
          <select id="horizonte" class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl">
            <option value="1">1 mes</option>
            <option value="2">2 meses</option>
            <option value="3" selected>3 meses</option>
            <option value="6">6 meses</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Riesgo</label>
          <select id="nivelRiesgo" class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl">
            <option value="">Todos</option>
            <option value="CRÍTICO">Crítico</option>
            <option value="ALTO">Alto</option>
            <option value="MEDIO">Medio</option>
          </select>
        </div>
        <div class="flex items-end space-x-2">
          <button id="btnReset" class="flex-1 px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition flex items-center justify-center gap-2">
            <i class="fas fa-redo"></i> Reiniciar
          </button>
          <button id="btnExport" class="px-6 py-3 bg-gradient-to-r from-emerald-600 to-cyan-600 text-white font-bold rounded-xl hover:from-emerald-700 hover:to-cyan-700 transition flex items-center gap-2">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8 fade-in">
      <div class="card bg-gradient-to-br from-blue-600 to-blue-800 text-white p-4">
        <p class="text-blue-100 text-xs opacity-90">Recetado 2025</p>
        <p class="text-2xl font-bold mt-1" id="kpiRecetado">0</p>
      </div>
      <div class="card bg-gradient-to-br from-emerald-600 to-emerald-800 text-white p-4">
        <p class="text-emerald-100 text-xs opacity-90">Dispensado</p>
        <p class="text-2xl font-bold mt-1" id="kpiDispensado">0</p>
      </div>
      <div class="card bg-gradient-to-br from-red-600 to-red-800 text-white p-4">
        <p class="text-red-100 text-xs opacity-90">Faltante</p>
        <p class="text-2xl font-bold mt-1" id="kpiFaltante">0</p>
      </div>
      <div class="card bg-gradient-to-br from-purple-600 to-violet-800 text-white p-4">
        <p class="text-purple-100 text-xs opacity-90">Predicción 2026</p>
        <p class="text-2xl font-bold mt-1" id="kpiPrediccion">0</p>
      </div>
      <div class="card bg-gradient-to-br from-orange-600 to-amber-700 text-white p-4">
        <p class="text-orange-100 text-xs opacity-90">En Riesgo</p>
        <p class="text-2xl font-bold mt-1" id="kpiQuiebres">0</p>
      </div>
      <div class="card bg-gradient-to-br from-pink-600 to-rose-700 text-white p-4">
        <p class="text-pink-100 text-xs opacity-90">Tasa</p>
        <p class="text-2xl font-bold mt-1" id="kpiTasa">0%</p>
      </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8 fade-in">
      <div class="card p-6">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-3">
          <i class="fas fa-chart-line text-purple-600"></i> Evolución + Predicción
        </h2>
        <div class="chart-container">
          <canvas id="chartPrediccion"></canvas>
        </div>
      </div>
      <div class="card p-6">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-3">
          <i class="fas fa-skull-crossbones text-red-600"></i> Top 10 Riesgo
        </h2>
        <div class="chart-container">
          <canvas id="chartQuiebreFuturo"></canvas>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 fade-in">
      <div class="card p-6">
        <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-chart-pie text-orange-600 mr-2"></i> Distribución Riesgos
        </h2>
        <div class="chart-container-sm">
          <canvas id="chartRiesgo"></canvas>
        </div>
      </div>
      <div class="card p-6">
        <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
          <i class="fas fa-trend-up text-green-600 mr-2"></i> Tendencias Mensuales
        </h2>
        <div class="chart-container-sm">
          <canvas id="chartTendencias"></canvas>
        </div>
      </div>
    </div>

    <div class="card p-6 fade-in">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-4">
        <i class="fas fa-bell text-red-600 pulse"></i> Medicamentos en Alerta Crítica
      </h2>
      <div class="overflow-x-auto scrollbar-thin" style="max-height: 500px;">
        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700">
          <thead class="bg-gradient-to-r from-red-700 to-rose-800 text-white sticky top-0">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-bold uppercase">Rank</th>
              <th class="px-4 py-3 text-left text-xs font-bold uppercase">Medicamento</th>
              <th class="px-4 py-3 text-right text-xs font-bold uppercase">Demanda 2025</th>
              <th class="px-4 py-3 text-right text-xs font-bold uppercase">Pronóstico 6 meses</th>
              <th class="px-4 py-3 text-center text-xs font-bold uppercase">Déficit Actual</th>
              <th class="px-4 py-3 text-center text-xs font-bold uppercase">Riesgo</th>
              <th class="px-4 py-3 text-center text-xs font-bold uppercase">Acción</th>
            </tr>
          </thead>
          <tbody id="tablaPrediccion" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    const { DateTime } = luxon;
    let data = { mensual: [], prediccionQuiebres: [], farmacias: [] };
    let filters = { farmacia: "", horizonte: 3, nivelRiesgo: "" };
    let charts = {};

    async function init() {
      try {
        const [mensual, prediccionQuiebres, farmacias, kpiTendencias] = await Promise.all([
          fetch('resumen_mensual.json').then(r => r.json()),
          fetch('prediccion_quiebres.json').then(r => r.json()),
          fetch('top_farmacias.json').then(r => r.json()),
          fetch('kpi_tendencias.json').then(r => r.json())
        ]);
        
        // Transformar prediccion_quiebres a estructura compatible
        const prediccionTransformada = prediccionQuiebres.map((item, index) => ({
          rank: index + 1,
          nombre_medicamento: item.TextoBreveMedicamento || item.MedicamentoSAP,
          demanda_historica_total: item.recetado_acumulado || 0,
          pronostico_ene_jun_2026: item.pronostico_mes_siguiente * 6,
          crecimiento_esperado_porcentaje: Math.round(((item.pronostico_mes_siguiente * 6 - item.recetado_acumulado) / item.recetado_acumulado * 100) * 10) / 10,
          nivel_riesgo: determinarRiesgo(item.deficit_actual, item.pronostico_mes_siguiente),
          recomendacion: item.deficit_actual > item.pronostico_mes_siguiente * 2 ? "URGENTE" : "MONITOREAR",
          deficit_actual: item.deficit_actual,
          demanda_promedio_mensual: item.demanda_promedio_mensual
        }));

        data = { 
          mensual, 
          prediccion: prediccionTransformada, 
          farmacias,
          kpiTendencias
        };
        
        // Actualizar última actualización desde metadata.json si existe
        try {
          const metadata = await fetch('metadata.json').then(r => r.json());
          document.getElementById('lastUpdate').textContent = 
            new Date(metadata.generated_at).toLocaleString('es-PY');
        } catch {
          document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-PY');
        }
        
        populateFarmacias();
        setupEvents();
        updateAll();
      } catch (e) {
        console.error("Error:", e);
        alert("Error cargando datos. Verifica que todos los JSON estén en la carpeta.");
      }
    }

    function determinarRiesgo(deficit, pronostico) {
      if (deficit > pronostico * 3) return "CRÍTICO";
      if (deficit > pronostico * 2) return "ALTO";
      return "MEDIO";
    }

    function populateFarmacias() {
      const sel = document.getElementById('farmaciaFilter');
      sel.innerHTML = '<option value="">Todas</option>';
      data.farmacias.forEach(f => {
        const opt = new Option(`Farmacia ${f.FarmaciaVentanilla}`, f.FarmaciaVentanilla);
        sel.add(opt);
      });
    }

    function setupEvents() {
      document.getElementById('farmaciaFilter').onchange = e => { 
        filters.farmacia = e.target.value; 
        updateAll(); 
      };
      document.getElementById('horizonte').onchange = e => { 
        filters.horizonte = parseInt(e.target.value); 
        updateAll(); 
      };
      document.getElementById('nivelRiesgo').onchange = e => { 
        filters.nivelRiesgo = e.target.value; 
        updateAll(); 
      };
      document.getElementById('btnReset').onclick = () => {
        filters = { farmacia: "", horizonte: 3, nivelRiesgo: "" };
        document.getElementById('farmaciaFilter').value = "";
        document.getElementById('horizonte').value = 3;
        document.getElementById('nivelRiesgo').value = "";
        updateAll();
      };
      document.getElementById('btnExport').onclick = () => {
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.prediccion), "Predicción Quiebres");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.mensual), "Resumen Mensual");
        XLSX.writeFile(wb, `IPS_Predicción_Quiebres_${new Date().toISOString().slice(0,10)}.xlsx`);
      };
      document.getElementById('darkModeToggle').onclick = () => document.documentElement.classList.toggle('dark');
    }

    function updateAll() {
      updateKPIs();
      updateChartPrediccion();
      updateChartQuiebreFuturo();
      updateChartRiesgo();
      updateChartTendencias();
      updateTablaPrediccion();
    }

    function updateKPIs() {
      const totalRec = data.mensual.reduce((s, m) => s + m.total_recetado, 0);
      const totalDisp = data.mensual.reduce((s, m) => s + m.total_dispensado, 0);
      const tasa = totalRec > 0 ? (totalDisp / totalRec * 100).toFixed(1) : 0;
      const pronostico = data.prediccion.reduce((s, p) => s + p.pronostico_ene_jun_2026, 0);
      const criticos = data.prediccion.filter(p => p.nivel_riesgo === "CRÍTICO").length;

      document.getElementById('kpiRecetado').textContent = totalRec.toLocaleString();
      document.getElementById('kpiDispensado').textContent = totalDisp.toLocaleString();
      document.getElementById('kpiFaltante').textContent = (totalRec - totalDisp).toLocaleString();
      document.getElementById('kpiPrediccion').textContent = Math.round(pronostico).toLocaleString();
      document.getElementById('kpiQuiebres').textContent = criticos;
      document.getElementById('kpiTasa').textContent = tasa + '%';
    }

    function updateChartPrediccion() {
      const ctx = document.getElementById('chartPrediccion').getContext('2d');
      const hist = data.mensual.sort((a,b) => a.año * 100 + a.mes - (b.año * 100 + b.mes));
      const labelsHist = hist.map(m => DateTime.fromObject({year: m.año, month: m.mes}).toFormat('MMM yyyy'));
      const dataHist = hist.map(m => m.total_recetado);
      
      // Calcular proyección basada en tendencia
      const ultimosMeses = hist.slice(-3);
      const promedioMensual = ultimosMeses.length > 0 ? 
        ultimosMeses.reduce((s, m) => s + m.total_recetado, 0) / ultimosMeses.length : 0;
      const crecimiento = 1.15; // 15% de crecimiento
      
      const labelsFut = Array.from({length: filters.horizonte}, (_, i) => {
        const fecha = DateTime.local().plus({months: i + 1});
        return fecha.toFormat('MMM yyyy');
      });
      
      const proyeccionMensual = promedioMensual * crecimiento;

      if (charts.prediccion) charts.prediccion.destroy();
      charts.prediccion = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [...labelsHist, ...labelsFut],
          datasets: [
            { 
              label: 'Real 2025', 
              data: [...dataHist, ...Array(filters.horizonte).fill(null)], 
              borderColor: '#4f46e5', 
              backgroundColor: 'rgba(79, 70, 229, 0.1)', 
              borderWidth: 3,
              tension: 0.4, 
              fill: true,
              pointBackgroundColor: '#4f46e5',
              pointRadius: 4
            },
            { 
              label: 'Proyección 2026', 
              data: [...Array(hist.length).fill(null), ...Array(filters.horizonte).fill(proyeccionMensual)], 
              borderColor: '#7c3aed', 
              backgroundColor: 'rgba(124, 58, 237, 0.2)', 
              borderDash: [6, 3], 
              borderWidth: 3,
              tension: 0.4,
              pointBackgroundColor: '#7c3aed',
              pointRadius: 4
            }
          ]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { 
            legend: { 
              position: 'top',
              labels: {
                font: { size: 12 },
                padding: 20
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    function updateChartQuiebreFuturo() {
      const ctx = document.getElementById('chartQuiebreFuturo').getContext('2d');
      let criticos = [...data.prediccion];
      
      if (filters.nivelRiesgo) {
        criticos = criticos.filter(p => p.nivel_riesgo === filters.nivelRiesgo);
      }
      
      criticos = criticos
        .sort((a, b) => b.pronostico_ene_jun_2026 - a.pronostico_ene_jun_2026)
        .slice(0, 10);
      
      if (charts.quiebre) charts.quiebre.destroy();
      charts.quiebre = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: criticos.map(p => p.nombre_medicamento.length > 25 ? 
            p.nombre_medicamento.substring(0, 25) + '...' : p.nombre_medicamento),
          datasets: [{
            label: 'Pronóstico 6 meses',
            data: criticos.map(p => p.pronostico_ene_jun_2026),
            backgroundColor: criticos.map(p => {
              if (p.nivel_riesgo === "CRÍTICO") return '#dc2626';
              if (p.nivel_riesgo === "ALTO") return '#f59e0b';
              return '#3b82f6';
            }),
            borderColor: criticos.map(p => {
              if (p.nivel_riesgo === "CRÍTICO") return '#b91c1c';
              if (p.nivel_riesgo === "ALTO") return '#d97706';
              return '#2563eb';
            }),
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: { 
          indexAxis: 'y', 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Pronóstico: ${context.raw.toLocaleString()}`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    function updateChartRiesgo() {
      const ctx = document.getElementById('chartRiesgo').getContext('2d');
      const niveles = { CRÍTICO: 0, ALTO: 0, MEDIO: 0, BAJO: 0 };
      
      data.prediccion.forEach(p => { 
        if (niveles[p.nivel_riesgo] !== undefined) {
          niveles[p.nivel_riesgo]++; 
        }
      });
      
      if (charts.riesgo) charts.riesgo.destroy();
      charts.riesgo = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Crítico', 'Alto', 'Medio'],
          datasets: [{ 
            data: [niveles.CRÍTICO, niveles.ALTO, niveles.MEDIO], 
            backgroundColor: ['#dc2626', '#f59e0b', '#3b82f6'],
            borderColor: ['#b91c1c', '#d97706', '#2563eb'],
            borderWidth: 2,
            hoverOffset: 15
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { 
            legend: { 
              position: 'bottom',
              labels: {
                padding: 20,
                font: { size: 12 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((context.raw / total) * 100);
                  return `${context.label}: ${context.raw} (${percentage}%)`;
                }
              }
            }
          }, 
          cutout: '65%'
        }
      });
    }

    function updateChartTendencias() {
      const ctx = document.getElementById('chartTendencias').getContext('2d');
      const hist = data.mensual.sort((a,b) => a.año * 100 + a.mes - (b.año * 100 + b.mes));
      
      if (charts.tendencias) charts.tendencias.destroy();
      charts.tendencias = new Chart(ctx, {
        type: 'line',
        data: {
          labels: hist.map(m => DateTime.fromObject({year: m.año, month: m.mes}).toFormat('MMM')),
          datasets: [
            { 
              label: 'Recetado', 
              data: hist.map(m => m.total_recetado), 
              borderColor: '#3b82f6', 
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 3,
              tension: 0.3,
              fill: true
            },
            { 
              label: 'Dispensado', 
              data: hist.map(m => m.total_dispensado), 
              borderColor: '#10b981', 
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 3,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { 
            legend: { 
              position: 'top',
              labels: {
                font: { size: 12 },
                padding: 20
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw.toLocaleString()}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    function updateTablaPrediccion() {
      const tbody = document.getElementById('tablaPrediccion');
      tbody.innerHTML = '';
      
      let filtered = [...data.prediccion];
      
      if (filters.nivelRiesgo) {
        filtered = filtered.filter(p => p.nivel_riesgo === filters.nivelRiesgo);
      }
      
      filtered = filtered.sort((a, b) => b.rank - a.rank).slice(0, 20);
      
      filtered.forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.className = i % 2 === 0 ? 'bg-gray-50 dark:bg-gray-900/50 hover:bg-gray-100 dark:hover:bg-gray-800' : 'hover:bg-gray-100 dark:hover:bg-gray-800';
        tr.style.transition = 'background-color 0.2s';
        
        const claseRiesgo = p.nivel_riesgo === 'CRÍTICO' ? 
          'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' : 
          p.nivel_riesgo === 'ALTO' ? 
          'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300' : 
          'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';
        
        const claseAccion = p.nivel_riesgo === 'CRÍTICO' ? 
          'bg-red-600 hover:bg-red-700' : 
          p.nivel_riesgo === 'ALTO' ? 
          'bg-orange-600 hover:bg-orange-700' : 
          'bg-blue-600 hover:bg-blue-700';
        
        tr.innerHTML = `
          <td class="px-4 py-3 font-bold text-center">${p.rank}</td>
          <td class="px-4 py-3 font-medium">${p.nombre_medicamento}</td>
          <td class="px-4 py-3 text-right font-mono">${p.demanda_historica_total.toLocaleString()}</td>
          <td class="px-4 py-3 text-right font-bold text-purple-600 dark:text-purple-400 font-mono">${Math.round(p.pronostico_ene_jun_2026).toLocaleString()}</td>
          <td class="px-4 py-3 text-center font-bold ${p.deficit_actual > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'} font-mono">
            ${p.deficit_actual.toLocaleString()}
          </td>
          <td class="px-4 py-3 text-center">
            <span class="px-3 py-1 rounded-full text-xs font-bold ${claseRiesgo}">
              ${p.nivel_riesgo}
            </span>
          </td>
          <td class="px-4 py-3 text-center">
            <button class="px-4 py-2 rounded-lg text-white font-bold text-sm transition ${claseAccion}">
              ${p.recomendacion}
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    init();
  </script>
</body>
</html>
